<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ø§Ù…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    :root { --brand:#f4e733; --bg:#000; --panel:#111; --text:#fff; }
    *{box-sizing:border-box}
    body{font-family:"NotoKufiArabic",sans-serif;background:#111;color:#fff;margin:0;padding:20px}
    .box{max-width:760px;margin:auto;background:var(--bg);border:2px solid var(--brand);border-radius:14px;padding:22px}
    h2{margin:0 0 16px;color:var(--brand);text-align:center}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .full{grid-column:1 / -1}
    label{display:block;font-weight:800;color:var(--brand);margin:0 0 6px}
    input{width:100%;background:var(--panel);color:var(--text);border:1px solid #444;border-radius:10px;padding:10px}
    input[readonly]{opacity:.85}
    .actions{display:flex;gap:10px;margin-top:6px}
    .btn{background:var(--brand);color:#000;border:0;border-radius:10px;padding:12px 16px;font-weight:800;cursor:pointer}
    .btn.secondary{background:#222;color:#fff;border:1px solid #444}
    .hint{font-size:12px;color:#bdbdbd;margin-top:6px}
    .status{margin-top:12px;display:none}
    .ok{color:#8be28b}.err{color:#ff9a9a}.info{color:#c9d7ff}
    .hr{height:1px;background:#222;margin:14px 0}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;z-index:9999}
    .modal .inner{width:min(95vw,720px);background:#000;border:2px solid var(--brand);border-radius:14px;padding:12px}
    .modal header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .modal h3{margin:0;color:var(--brand)}
    .close-x{background:transparent;border:0;color:#fff;font-size:22px;cursor:pointer}
    #reader{width:100%}
    @media (max-width:768px){ .row{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="box">
    <h2>Ø§Ø³ØªÙ…Ø§Ø±Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„</h2>

    <form id="generalForm" autocomplete="off">
      <div class="row full">
        <div class="full">
          <label for="id">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙÙŠ (ID)</label>
          <div class="actions">
            <input id="id" name="id" inputmode="numeric" placeholder="Ø§Ø³Ø­Ø¨ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø£Ùˆ Ø§Ù…Ø³Ø­ Ø§Ù„Ù€ QR/Barcode" required style="flex:1" />
            <button class="btn secondary" type="button" id="scanBtn">Ù…Ø³Ø­ Ø§Ù„Ù‡ÙˆÙŠØ©</button>
          </div>
          <div class="hint">Ø§Ø¶ØºØ· Ù…Ø³Ø­ Ø§Ù„Ù‡ÙˆÙŠØ©</div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <div>
          <label for="fullname">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
          <input id="fullname" name="fullname" required />
        </div>

        <div>
          <label for="birthdate">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label>
          <input id="birthdate" name="birthdate" type="date" required />
        </div>

        <div>
          <label for="age">Ø§Ù„Ø¹Ù…Ø±</label>
          <input id="age" name="age" type="number" readonly />
        </div>
      </div>

      <div class="actions" style="margin-top:16px">
        <button class="btn" type="submit">Ø¥Ø±Ø³Ø§Ù„</button>
        <button class="btn secondary" type="reset" id="resetBtn">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
      </div>

      <div id="s-info" class="status info">Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ù‡ÙˆÙŠØ©â€¦</div>
      <div id="s-ok"   class="status ok">ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ¹Ø¨Ø¦ØªÙ‡Ø§.</div>
      <div id="s-err"  class="status err">ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù‡ÙˆÙŠØ© Ø£Ùˆ Ø­Ø¯Ø« Ø®Ø·Ø£.</div>
    </form>
  </div>

  <div class="modal" id="scanModal" role="dialog" aria-modal="true">
    <div class="inner">
      <header>
        <h3>Ù…Ø³Ø­ Ø§Ù„Ù‡ÙˆÙŠØ© (QR/Barcode)</h3>
        <button class="close-x" id="closeScan" title="Ø¥ØºÙ„Ø§Ù‚">Ã—</button>
      </header>
      <div id="reader"></div>
    </div>
  </div>

  <script>
  const LOOKUP_URL = "https://script.google.com/macros/s/AKfycbw6Efui13sVxFmFuzesazRBdZjBJP-wSMpgLkeFGBwva2gFVVLjQy0qHjgSdWKg9F9E/exec";
  const USE_JSONP  = true;


  const idInput    = document.getElementById('id');
  const nameInput  = document.getElementById('fullname');
  const birthInput = document.getElementById('birthdate');
  const ageInput   = document.getElementById('age');
  const form       = document.getElementById('generalForm');

  const sInfo = document.getElementById('s-info');
  const sOk   = document.getElementById('s-ok');
  const sErr  = document.getElementById('s-err');

  function setStatus(which){ [sInfo,sOk,sErr].forEach(x=>x.style.display='none'); if(which) which.style.display='block'; }
  function pad2(n){return String(n).padStart(2,'0');}
  function toISODate(d){ 
    if(!d) return '';
    if(/^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
    const m = d.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
    if(m){ const [_,dd,mm,yyyy]=m; return `${yyyy}-${pad2(mm)}-${pad2(dd)}`; }
    return '';
  }
  function calcAge(iso){
    if(!iso) return '';
    const b = new Date(iso); if(isNaN(b)) return '';
    const t = new Date();
    let a = t.getFullYear() - b.getFullYear();
    const m = t.getMonth() - b.getMonth();
    if(m<0 || (m===0 && t.getDate()<b.getDate())) a--;
    return Math.max(0,a);
  }
  const updateAge = ()=> { ageInput.value = calcAge(birthInput.value) || '' };
  birthInput.addEventListener('change', updateAge);
  birthInput.addEventListener('input',  updateAge);

  function parseScannedId(text){
    if(!text) return '';
    const pipe = text.split('|')[0] || text;
    const kalba = pipe.match(/KalbaSC-(\d+)/i);
    if(kalba) return kalba[1];
    const m = text.match(/(\d{5,})/);
    return m ? m[1] : text.trim();
  }

  function fillFromResult(r){
    if(!r || !r.ok) { setStatus(sErr); return; }
    if(r.fullname)  nameInput.value  = r.fullname;
    if(r.birthdate){
      const iso = toISODate(r.birthdate);
      if(iso) birthInput.value = iso;
    }
    updateAge();
    setStatus(sOk);
  }

  function lookupByIdJSONP(id){
    const cb = "__cb" + Math.random().toString(36).slice(2);
    window[cb] = (data)=>{ try{ fillFromResult(data); } finally{
      delete window[cb]; s.remove(); } };
    const url = `${LOOKUP_URL}?fn=lookup&id=${encodeURIComponent(id)}&callback=${cb}`;
    const s = document.createElement('script'); s.src = url; s.onerror = ()=>{ setStatus(sErr); };
    document.head.appendChild(s);
  }

  async function lookupByIdFetch(id){
    try{
      const resp = await fetch(`${LOOKUP_URL}?fn=lookup&id=${encodeURIComponent(id)}`, { method:'GET', mode:'cors' });
      const data = await resp.json();
      fillFromResult(data);
    }catch(e){ setStatus(sErr); }
  }

  function lookupById(id){
    if(!id) return;
    setStatus(sInfo);
    (USE_JSONP ? lookupByIdJSONP : lookupByIdFetch)(id);
  }

  function triggerLookup(){
    const id = (idInput.value || '').trim();
    if(id) lookupById(id);
  }

  window.addEventListener('load', ()=> idInput.focus());
  idInput.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){ e.preventDefault(); triggerLookup(); }
  });
  idInput.addEventListener('change', triggerLookup);
  idInput.addEventListener('blur',   triggerLookup);

let html5Qrcode, isScanning = false;
  const scanBtn   = document.getElementById('scanBtn');
  const scanModal = document.getElementById('scanModal');
  const closeScan = document.getElementById('closeScan');

  function supportedFormats(){
    // If the library exposes Html5QrcodeSupportedFormats, use it; otherwise fall back to QR only
    if (window.Html5QrcodeSupportedFormats) {
      return [
        Html5QrcodeSupportedFormats.QR_CODE,
        Html5QrcodeSupportedFormats.CODE_128,
        Html5QrcodeSupportedFormats.EAN_13,
        Html5QrcodeSupportedFormats.CODE_39,
        Html5QrcodeSupportedFormats.PDF_417
      ];
    }
    return undefined; // QR only (older versions)
  }

  function parseScannedId(text){
    if(!text) return '';
    // If your QR text is like "KalbaSC-12345|...":
    const head = text.split('|')[0] || text;
    const mKalba = head.match(/KalbaSC-(\d+)/i);
    if (mKalba) return mKalba[1];
    // Otherwise, take the longest 5+ digit run (barcode numeric)
    const mNum = text.match(/(\d{5,})/);
    return mNum ? mNum[1] : text.trim();
  }

  function openScanner(){
    scanModal.style.display = 'flex';
    if(isScanning) return;
    isScanning = true;

    // ensure the modal container is present
    html5Qrcode = new Html5Qrcode("reader");
    const config = {
      fps: 10,
      qrbox: { width: 320, height: 200 },
      aspectRatio: 1.7778,
      formatsToSupport: supportedFormats() // may be undefined (QR-only)
    };

    html5Qrcode.start(
      { facingMode: "environment" },
      config,
      (decodedText/*, decodedResult*/) => {
        // ğŸ”¥ fill ID, close camera, and lookup
        const id = parseScannedId(decodedText);
        if (id) {
          idInput.value = id;
          closeScanner();
          triggerLookup(); // fill name + birthdate + age
        }
      },
      () => {} // ignore continuous decode errors
    ).catch(err => {
      isScanning = false;
      alert("ØªØ¹Ø°Ø± ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¥Ø·Ø§Ø±: " + err);
    });
  }

  function closeScanner(){
    if(html5Qrcode){
      html5Qrcode.stop().then(()=>{
        html5Qrcode.clear();
        html5Qrcode = null;
        isScanning = false;
      }).catch(()=>{});
    }
    scanModal.style.display = 'none';
  }

  scanBtn.addEventListener('click', openScanner);
  closeScan.addEventListener('click', closeScanner);
  scanModal.addEventListener('click', (e)=>{ if(e.target === scanModal) closeScanner(); });

  form.addEventListener('submit', (e)=>{
    e.preventDefault();
    alert('Ø³ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ Ù‡Ù†Ø§ (Ø§Ø±Ø¨Ø·Ù‡ Ø¨Ø§Ù„Ù€ Apps Script Ù„Ø§Ø­Ù‚Ù‹Ø§)');
  });

  document.getElementById('resetBtn').addEventListener('click', ()=>{
    setStatus(); setTimeout(()=>idInput.focus(),0);
  });
  </script>
</body>
</html>
